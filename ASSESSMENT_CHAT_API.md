# API مستندسازی: گفتگوی ارزیابی شایستگی

این سند ساختار درخواست و پاسخ سرویس گفتگوی ارزیابی را توضیح می‌دهد تا فرانت‌اند بتواند به‌سادگی آن را پیاده‌سازی کند.

## Endpoint
- **Method:** `POST`
- **URL:** `/api/assessment/chat/{questionnaireId}`
  - به جای `{questionnaireId}` شناسه‌ی ارزیابی (عدد) قرار می‌گیرد.

## احراز هویت
- اگر کاربر از داخل پنل لاگین کرده باشد، کوکی جلسه‌ی NextAuth به‌صورت خودکار خوانده می‌شود.
- در سناریوهای مستقل (مثلاً اپ موبایل)، می‌توانید هدر `Authorization: Bearer <token>` ارسال کنید تا سرویس کاربر را شناسایی کند.

## بدنه‌ی درخواست
```json
{
  "session_id": "string",
  "message": "string",
  "autoStart": false
}
```
- `session_id` (ضروری): شناسه جلسه‌ی جاری که هنگام شروع ارزیابی ایجاد شده است.
- `message`: متن پیام کاربر. اگر `autoStart=true` باشد می‌تواند خالی بماند.
- `autoStart` (اختیاری): زمانی که `true` باشد، بدون نیاز به پیام کاربر، ربات مکالمه را آغاز می‌کند.

## نمونه‌ی درخواست
```http
POST /api/assessment/chat/12 HTTP/1.1
Content-Type: application/json
Authorization: Bearer <JWT>

{
  "session_id": "sess-123",
  "message": "سلام، آماده‌ام شروع کنیم.",
  "autoStart": false
}
```

## پاسخ موفق
```json
{
  "success": true,
  "data": {
    "reply": "متن پاسخ دستیار به زبان فارسی",
    "personaName": "نام شخصیتی که پاسخ را داده است",
    "isComplete": false,
    "completionToken": null
  }
}
```
- `reply`: متن پاک‌سازی‌شده‌ی پاسخ (توکن‌های کنترلی حذف شده‌اند).
- `personaName`: نام شخصیتی که پاسخ را تولید کرده است. ممکن است در مداخله‌ی ناظر تغییر کند.
- `isComplete`: اگر پاسخ شامل هر یک از توکن‌های پایان مکالمه (`__CONVERSATION_END__` یا `[END_ASSESSMENT]`) باشد مقدار آن `true` می‌شود.
- `completionToken`: در صورت تشخیص پایان، نام توکن پیدا شده را برمی‌گرداند؛ در غیر این صورت `null` است. این مقدار می‌تواند برای دیباگ یا تصمیم‌گیری‌های خاص مفید باشد.

## پاسخ خطا
```json
{
  "success": false,
  "message": "توضیح خطا"
}
```

## نکات تکمیلی
- توکن‌های پایان مکالمه پس از تشخیص از پاسخ حذف می‌شوند؛ بنابراین `reply` برای نمایش مستقیم آماده است.
- مکالمه‌ی کامل (بدون توکن‌های کنترلی) در پایگاه‌داده ذخیره می‌شود تا در ادامه‌ی ارزیابی یا تحلیل‌ها قابل استفاده باشد.
- اگر شخصیت دوم (ناظر) فعال باشد و پاسخ کاربر را «نامعتبر» تشخیص دهد، پاسخ مداخله با نام ناظر ارسال می‌شود.
